<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ÏòÅÌôî ÏÉÅÏÑ∏</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/movieDetail.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>

<div id="main-area">
    <div th:replace="header :: siteHeader"></div>

    <div id="main" class="soft-bg">
        <div class="row">
            <div id="movieDetail-left" class="col-lg-5 pr-5 position-relative">

                <img src="/images/border-end-img.png" class="border-end-img-vertical border-end-img-top">
                <img src="/images/border-end-img.png" class="border-end-img-vertical border-end-img-bottom">

                <div class="mb-3 image-box d-flex justify-content-center align-items-center">
                    <img th:src="'https://image.tmdb.org/t/p/w500' + ${movie.posterUrl}" alt="ÏòÅÌôî Ìè¨Ïä§ÌÑ∞" class="poster-img"/>
                </div>

                <!-- Í∞ÄÎ°ú Íµ¨Î∂ÑÏÑ† -->
                <div class="white-line"></div>

                <!-- ÏòÅÌôî Ï†úÎ™© -->
                <div class="row mb-3 align-items-center">
                    <span class="title-intro">Ï†úÎ™©</span>
                    <div class="title">
                        <span th:text="${movie.title != null and !movie.title.isEmpty() ? movie.title : movie.titleOriginal}"></span>
                        <button id="openPlaylistModalBtn" class="btn btn-outline-danger"
                                th:onclick="'openPlaylistModal(' + ${movie.id} + ')'">
                            ‚ù§Ô∏è
                        </button>
                    </div>
                </div>

                <!-- Í∞ÄÎ°ú Íµ¨Î∂ÑÏÑ† -->
                <div class="white-line"></div>

                <!-- ÏÑ∏Î∂Ä Ï†ïÎ≥¥ -->
                <div class="row mb-3 align-items-center">
                    <span class="details-title">ÏÑ∏Î∂Ä Ï†ïÎ≥¥</span>
                    <div class="details-content">
                        <div>Í∞êÎèÖ: <span th:text="${movie.director}"></span></div>
                        <div>Ï∂úÏó∞: <span th:text="${movie.cast}"></span></div>
                        <div>Ïû•Î•¥:
                            <span th:text="${movie.genres != null && !movie.genres.isEmpty() ? movie.genres : 'Ïû•Î•¥ Ï†ïÎ≥¥ ÏóÜÏùå'}"></span>
                        </div>
                        <div>Í∞úÎ¥âÏùº: <span th:text="${movie.releaseDate}"></span></div>
                    </div>
                </div>

                <!-- Í∞ÄÎ°ú Íµ¨Î∂ÑÏÑ† -->
                <div class="white-line"></div>

                <!-- Ï§ÑÍ±∞Î¶¨ -->
                <div class="row mb-3 align-items-center">
                    <span class="details-title">Ï§ÑÍ±∞Î¶¨</span>
                    <div class="synopsis-content">
                        <span th:text="${movie.synopsis != null and !movie.synopsis.isEmpty() ? movie.synopsis : movie.synopsisOriginal}"></span>
                    </div>
                </div>
            </div>

            <div id="movieDetail-right" class="col-lg-7 pl-0">
                <div class="reviews">
                    <!-- Î¶¨Î∑∞ Ï†úÎ™© -->
                    <div class="reviews-header mb-3">
                        <span class="reviews-intro">ÏòÅÌôî Î¶¨Î∑∞</span>

                        <select id="sort-select" class="form-select" style="width: auto;">
                            <option value="newest">ÏµúÏã†Ïàú</option>
                            <option value="oldest">Ïò§ÎûòÎêú Ïàú</option>
                            <option value="most-likes">Ï¢ãÏïÑÏöî ÎßéÏùÄ Ïàú</option>
                            <option value="least-likes">Ï¢ãÏïÑÏöî Ï†ÅÏùÄ Ïàú</option>
                        </select>
                    </div>

                    <!-- Î¶¨Î∑∞ Î™©Î°ù -->
                    <div class="reviews-list">
                        <div th:each="review : ${reviews}"
                             class="review-card mb-3"
                             th:attr="data-created=${review.createdDate}, data-updated=${review.updatedDate}">
                            <div class="review-card-body">
                                <div class="review-top d-flex justify-content-between align-items-center">
                                    <!-- Î≥ÑÏ†ê -->
                                    <div class="rating">
                                        <div class="star-container">
                                            <!-- ÍΩâ Ï∞¨ Î≥ÑÎì§ -->
                                            <span th:each="i : ${#numbers.sequence(1, review.fullStars)}" class="star full">‚òÖ</span>

                                            <!-- Î∞ò Î≥Ñ (ÏûàÎã§Î©¥) -->
                                            <span th:if="${review.halfStar}" class="star half">‚òÖ</span>

                                            <!-- ÎπÑÏñ¥ÏûàÎäî Î≥ÑÎì§ -->
                                            <span th:each="i : ${#numbers.sequence(1, review.emptyStars)}"
                                                  th:if="${review.emptyStars > 0}"
                                                  class="star empty">‚òÖ</span>                                        </div>
                                    </div>

                                    <!-- ÎãâÎÑ§ÏûÑ Îì±Í∏â -->
                                    <div class="nickname-grade">
                                        <h5 class="nickname" th:text="${review.user.nickname}"></h5>
                                        <img th:src="@{/images/badge_{gradeName}.png(gradeName=${review.user.gradeName.toLowerCase()})}"
                                             alt="Îì±Í∏â Î∞∞ÏßÄ"
                                             style="height: 24px;" />
                                        <span th:if="${review.user.gradeId >= 4}" class="badge-editor">ÏóêÎîîÌÑ∞ Ï∂îÏ≤ú</span>
                                    </div>


                                </div>

                                <!-- Î¶¨Î∑∞ ÎÇ¥Ïö© -->
                                <div class="review-content">
                                    <div class="review-content-box">
                                        <span th:text="${review.getContent()}"></span>
                                    </div>
                                </div>

                                <!-- Î≤ÑÌäº -->
                                <div class="review-buttons d-flex justify-content-between align-items-center mt-2">
                                    <div class="buttons">
                                        <!-- Ï¢ãÏïÑÏöî Î≤ÑÌäº -->
                                        <button class="like-button btn btn-sm"
                                                th:data-review-id="${review.id}"
                                                th:classappend="${likedReviewIds.contains(review.id)} ? 'btn-primary liked' : 'btn-outline-primary'"
                                                th:attr="data-liked=${likedReviewIds.contains(review.id)}">
                                            Ï¢ãÏïÑÏöî (<span class="like-count" th:text="${review.likeCount}">0</span>)
                                        </button>

                                        <!-- ÏÇ≠Ï†ú Î≤ÑÌäº -->
                                        <button
                                                type="button"
                                                class="delete-button btn btn-sm btn-outline-danger"
                                                th:if="${review.user.userId == userId}">
                                            ÏÇ≠Ï†ú
                                        </button>
                                    </div>

                                    <!-- ÏÉùÏÑ±/ÏàòÏ†ï ÎÇ†Ïßú -->
                                    <p class="review-date">
                                        ÏûëÏÑ± ÎÇ†Ïßú:
                                        <span th:text="${#temporals.format(review.displayDate, 'yyyy-MM-dd HH:mm')}"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Î≤ÑÌäºÎì§ -->
                    <div class="pagination-container d-flex justify-content-center mt-4">
                        <button class="pagination-btn" id="prev-btn">&lt; Ïù¥Ï†Ñ</button>
                        <div class="pagination-numbers" id="pagination-numbers"></div>
                        <button class="pagination-btn" id="next-btn">Îã§Ïùå &gt;</button>
                    </div>
                </div>

                <!-- Í∞ÄÎ°ú Íµ¨Î∂ÑÏÑ† -->
                <div class="white-line-right"></div>

                <!-- Î¶¨Î∑∞ ÏÉùÏÑ±/ÏàòÏ†ï -->
                <div class="review-create-update mb-3">
                    <div class="reviews-header mb-3">
                        <span class="reviews-intro">Î¶¨Î∑∞ ÏûëÏÑ±</span>
                    </div>

                    <!-- Î≥ÑÏ†ê ÏûÖÎ†• -->
                    <div class="rating-section mb-3">
                        <div class="rating-input-star">
                            <label class="rating-label">Î≥ÑÏ†ê</label>
                            <div class="rating-stars" id="rating-stars"></div>
                            <span id="rating-value" class="rating-score">0.0</span>
                        </div>
                    </div>

                    <!-- Î¶¨Î∑∞ ÎÇ¥Ïö© ÏûÖÎ†• -->
                    <div class="content-input mb-3">
                        <label class="content-label">Î¶¨Î∑∞ ÏûëÏÑ±</label>
                        <textarea class="review-input-content" placeholder="Î¶¨Î∑∞ÏôÄ Î≥ÑÏ†êÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                    </div>

                    <!-- Î¶¨Î∑∞ ÏÉùÏÑ±/ÏàòÏ†ï ÏÇ≠Ï†ú Î≤ÑÌäº -->
                    <div class="review-submit-container">
                        <button class="review-submit-btn"
                                th:text="${hasUserReviewed ? 'Î¶¨Î∑∞ ÏàòÏ†ï' : 'Î¶¨Î∑∞ ÏÉùÏÑ±'}"
                                th:data-movie-id="${movieId}"
                                th:data-user-id="${userId}"
                                th:data-review-id="${hasUserReviewed ? reviews[0].id : ''}">
                        </button>

                        <button class="review-delete-btn btn btn-danger"
                                th:if="${hasUserReviewed}"
                                th:data-review-id="${reviews[0].id}"
                                th:data-movie-id="${movieId}">
                            ÏÇ≠Ï†ú
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="chat-button"
     id="chatButton"
     th:data-href="@{/chatroom/{id}(id=${movieId})}"
     th:data-user-id="${userId}"
     th:data-grade-id="${userGradeId}">
    <img src="/images/chat.png" alt="Ï±ÑÌåÖ" style="width: 35px; height: 35px;" />
</div>
<!-- ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ Î™®Îã¨ -->
<div class="modal fade" id="playlistModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">üé¨ ÎÇ¥ ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Îã´Í∏∞"></button>
            </div>

            <div class="modal-body">
                <!-- ÏÉà Î¶¨Ïä§Ìä∏ ÏÉùÏÑ± -->
                <div class="mb-3">
                    <button class="btn btn-primary" onclick="showCreatePlaylistForm()">‚ûï ÏÉà ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ÏÉùÏÑ±</button>
                </div>

                <!-- ÏÉùÏÑ± Ìèº (ÌÜ†Í∏Ä) -->
                <div id="createPlaylistForm" class="mb-3" style="display: none;">
                    <input type="text" id="newPlaylistName" class="form-control mb-2" placeholder="Î¶¨Ïä§Ìä∏ Ïù¥Î¶Ñ">
                    <textarea id="newPlaylistDesc" class="form-control mb-2" placeholder="ÏÑ§Î™Ö (ÏÑ†ÌÉù)"></textarea>
                    <button class="btn btn-success" onclick="createPlaylist()">ÏÉùÏÑ±ÌïòÍ∏∞</button>
                </div>

                <!-- Î¶¨Ïä§Ìä∏ Î™©Î°ù -->
                <ul class="list-group" id="playlistList"></ul>

                <!-- Î¶¨Ïä§Ìä∏ ÎÇ¥ ÏòÅÌôî Î≥¥Í∏∞ -->
                <div id="playlistDetail" class="mt-4" style="display: none;">
                    <h6 id="playlistDetailTitle">üìΩÔ∏è ÌîåÎ†àÏù¥Î¶¨Ïä§Ìä∏ ÏòÅÌôî Î™©Î°ù</h6>
                    <ul class="list-group" id="playlistMovieList"></ul>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
            </div>

        </div>
    </div>
</div>

<script>
    function openPlaylistModal(movieId) {
        currentMovieId = movieId;
        const modal = new bootstrap.Modal(document.getElementById('playlistModal'));
        modal.show();
        loadMyPlaylists();
    }
</script>
<script src="/js/playlistModal.js"></script>
<script src="/js/movie-detail.js"></script>
</body>
</html>